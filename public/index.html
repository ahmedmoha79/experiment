<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Advanced GPS Tracker</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    #map { height: 100vh; width: 100%; margin: 0; }
    .emoji-marker { 
      font-size: 32px;
      text-shadow: 0 0 8px white, 0 0 8px white;
      filter: drop-shadow(0 0 4px black);
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <form id="locationForm">
    <label for="destination">Enter Destination:</label>
    <input type="text" id="destination" name="destination" required>
    <button type="submit">Go</button>
  </form>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/ua-parser-js@1.0.37/dist/ua-parser.min.js"></script>
  <script>
    const map = L.map('map', {
      zoomControl: true,
      maxZoom: 18,
      minZoom: 2
    }).setView([-13.1339, 27.8493], 15);

    const baseLayers = {
      "Street View": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap' }),
      "Satellite": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: '© Esri' })
    };
    baseLayers["Street View"].addTo(map);
    L.control.layers(baseLayers).addTo(map);

    let marker;

    function createPersonEmoji() {
      return L.divIcon({
        className: 'emoji-marker',
        html: '🚶‍♂️',
        iconSize: [48, 48],
        iconAnchor: [24, 48]
      });
    }

    async function getDeviceDetails() {
      const parser = new UAParser();
      const result = parser.getResult();
      return {
        deviceId: localStorage.getItem('advDeviceId') || `DEV-${Date.now()}`,
        os: `${result.os.name} ${result.os.version}`,
        userAgent: navigator.userAgent
      };
    }

    async function sendAdvancedLocation(lat, lng) {
      const deviceData = await getDeviceDetails();
      const payload = { latitude: lat, longitude: lng, device: deviceData };
      fetch('/api/gps', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      }).catch(e => console.error('Error:', e));
    }

    let lastPosition = null;
    setInterval(() => {
      navigator.geolocation.getCurrentPosition(
        pos => {
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;
          if (!lastPosition || lastPosition.lat !== lat || lastPosition.lng !== lng) {
            if (marker) marker.remove();
            marker = L.marker([lat, lng], { icon: createPersonEmoji() }).addTo(map);
            map.setView([lat, lng], map.getZoom());
            sendAdvancedLocation(lat, lng);
            lastPosition = { lat, lng };
          }
        },
        err => alert('GPS Error: ' + err.message),
        { enableHighAccuracy: true }
      );
    }, 2000);

    document.getElementById('locationForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const destination = document.getElementById('destination').value;
      fetch(`/api/directions?destination=${encodeURIComponent(destination)}`)
        .then(res => res.json())
        .then(data => console.log('Route:', data))
        .catch(err => console.error('Error:', err));
    });
  </script>
</body>
</html>
