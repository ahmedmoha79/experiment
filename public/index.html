<!DOCTYPE html>
<html>
<head>
  <title>Real GPS Tracker</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>#map{height:100vh;width:100%;margin:0}</style>
</head>
<body>
  <div id="map"></div>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const map = L.map('map').setView([-13.1339, 27.8493], 10);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
    let marker;

    // Generate or retrieve unique device ID
    function getDeviceId() {
      let deviceId = localStorage.getItem('deviceId');
      if (!deviceId) {
        deviceId = crypto.randomUUID();
        localStorage.setItem('deviceId', deviceId);
      }
      return deviceId;
    }

    // Improved device name detection
    function getDeviceName() {
      const ua = navigator.userAgent;
      
      // Try to get more specific device information
      const deviceInfo = {
        platform: navigator.platform,
        userAgent: ua,
        deviceMemory: navigator.deviceMemory || 'unknown',
        hardwareConcurrency: navigator.hardwareConcurrency || 'unknown',
        maxTouchPoints: navigator.maxTouchPoints || 'unknown'
      };

      // Parse Android devices
      if (/android/i.test(ua)) {
        const androidVersionMatch = ua.match(/Android\s([0-9.]+)/);
        const modelMatch = ua.match(/;\s([a-zA-Z0-9-]+)\sBuild/);
        return `Android ${androidVersionMatch ? androidVersionMatch[1] : 'Unknown Version'} (${
          modelMatch ? modelMatch[1] : 'Unknown Model'
        })`;
      }

      // Parse iOS devices
      if (/iphone|ipad|ipod/i.test(ua)) {
        const iosVersionMatch = ua.match(/OS\s([0-9_]+)/);
        return `iOS ${iosVersionMatch ? iosVersionMatch[1].replace(/_/g, '.') : 'Unknown Version'}`;
      }

      // Parse Windows devices
      if (/windows/i.test(ua)) {
        const windowsVersionMatch = ua.match(/Windows\sNT\s([0-9.]+)/);
        return `Windows ${windowsVersionMatch ? windowsVersionMatch[1] : 'Unknown Version'}`;
      }

      // Parse Mac devices
      if (/macintosh/i.test(ua)) {
        const macVersionMatch = ua.match(/Mac OS X\s([0-9_]+)/);
        return `Mac OS ${macVersionMatch ? macVersionMatch[1].replace(/_/g, '.') : 'Unknown Version'}`;
      }

      // Fallback to platform if no specific info found
      return navigator.platform || 'Unknown Device';
    }

    const deviceId = getDeviceId();
    const phoneName = getDeviceName();

    console.log('Device ID:', deviceId);
    console.log('Device Name:', phoneName);

    function sendLocation(lat, lng) {
      fetch('/api/gps', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          latitude: lat, 
          longitude: lng, 
          deviceId: deviceId,
          phoneName: phoneName
        })
      })
      .then(response => {
        if (!response.ok) {
          console.error('Server error:', response.status);
          return response.text().then(text => { throw new Error(text) });
        }
        return response.json();
      })
      .then(data => console.log('Location saved:', data))
      .catch(e => console.error('Error:', e));
    }

    navigator.geolocation.watchPosition(
      pos => {
        const lat = pos.coords.latitude, lng = pos.coords.longitude;
        if (marker) marker.remove();
        marker = L.marker([lat, lng]).addTo(map);
        map.setView([lat, lng], 15);
        sendLocation(lat, lng);
      },
      err => alert('GPS Error: ' + err.message),
      { enableHighAccuracy: true }
    );
  </script>
</body>
</html>
